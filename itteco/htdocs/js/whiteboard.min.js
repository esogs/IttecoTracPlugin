var contextMenu;var draggable_options={helper:"clone",handle:".drag_handle",opacity:0.8,start:function(b,a){a.helper.css("width",this.offsetWidth+"px")}};var rpc;window.popup_context={};jQuery.fn.outerHTML=function(){return $("<div>").append(this.eq(0).clone()).html()};function log(){if(typeof console!="undefined"&&console.log){console.log.apply("",arguments)}}function WBContext(){this.filter={field:new Object(),attr:new Object()};this.cpVisible=false;this._save=function(){var e="";var d=wbContext.filter.attr;for(var c in d){if(d[c]){e+="&filter$attr$"+c+"="+d[c]}}var b=wbContext.filter.field;for(var h in b){if(b[h]){e+="&filter$field$"+h+"="+b[h]}}e+="&cpVisible="+this.cpVisible;if(e.length>0){e=e.substring(1,e.length)}$.cookies.set("whiteboardDatabag",e)};this.load=function(){var a=$.cookies.get("whiteboardDatabag");if(a){var b=this;$.each(a.split("&"),function(){var e=this.split("=");var h=e[0].split("$");if(e.length>1){var c=h.length-1;var f=b;var d=0;while(d<c&&f){if(!f[h[d]]){f[h[d]]={}}f=f[h[d]];d++}if(f){f[h[c]]=e[1]}}})}};this.setFilter=function(b,a,c){if(b=="field"){this.filter.field[a]=c}else{this.filter.attr[a]=c}this._save()};this.toggleControlPanel=function(){if(this.cpVisible==true||this.cpVisible=="true"){this.cpVisible=false}else{this.cpVisible=true}this._save();return false}}var wbContext=new WBContext();update_cell=function(c,e){var d=c.siblings().andSelf().filter(".group_holder");var b="[status='"+c.attr("status")+"']";var a=".widget";if(e){a+=':not([idx="'+e+'"])'}$(".widget",d).each(function(f){calcAggregates(this,$(a,d.siblings()))});$(".whiteboard_table .group"+b).each(function(f){calcAggregates(this,$(a,$(".whiteboard_table .droppable"+b)))});enableAccordionIfAny(c);calcPercentage()};calcAllAggregates=function(){$(".group",$(".whiteboard_table")).each(function(a){calcAggregates(this,$(".droppable[status='"+$(this).attr("status")+"']",$(".whiteboard_table")))});$(".group_holder .widget").each(function(a){calcAggregates(this,$(this).parents(".group_holder").siblings())});calcPercentage()};calcAggregates=function(b,a){var c=$(b);$(".summary .parameter_value[field_name]",c).each(function(d){var e=$(this);var f=getAggregatesValues(e.attr("field_name"),a);e.attr(f);this.full_stats=f.full_stats;if(c.hasClass("calculated")){e.text(f.sum)}});setupProgressbar(b)};calcPercentage=function(){var a=0;$('.whiteboard_table tbody th .parameter_value[field_name="'+window.progress_field_name+'"]').each(function(b){a+=parseInt($(this).text(),10)});$(".whiteboard_table thead th .parameter_value").each(function(c){var e=$(this);var d=$(".percentage",e);var b=(100*parseInt(e.text())/a).toFixed(1);if(b>0){if(d.length==0){d=$('<span class="percentage"/>').appendTo(e)}d.text("("+b+"%)")}else{d.remove()}})};getAggregatesValues=function(d,c){var b=0,a={};for(g in window.stats_config){a[g]=0}$(".summary .parameter_value[field_name='"+d+"']",c.filter(".widget:visible, *:has(.widget:visible)")).each(function(f){var e=$(this).parents(".widget");var h=parseInt($(this).text());h=isNaN(h)?0:h;b+=h;if(window.stats_status_to_group){var j=window.stats_status_to_group[e.attr("status")];a[j]+=h}});return{sum:b,full_stats:a}};colorizeWidget=function(k){var n=ticket_rendering_config[k.attr("ticket_type")];if(n){var a=parseInt($(".summary .parameter_value[field_name='"+n.weight_field_name+"']",k).text());a=isNaN(a)?0:a;var r=parseInt(n.max_weight);var m=n.min_color;var b=n.max_color;if(r&&m&&b){var o="rgb(";for(var f=0;f<3;f++){if(f!=0){o+=","}var d=parseInt("0x"+m.substring(1+f*2,1+(f+1)*2),16);var j=parseInt("0x"+b.substring(1+f*2,1+(f+1)*2),16);o+=Math.round(d+(j-d)*(a/r))}o+=")";k.css("background-color",o)}var p=$(".status-icon",k);var q=n.icon_bg_color||"#0F0";if(stats_status_to_group){var e=stats_status_to_group[k.attr("status")];if(e&&stats_config[e]&&stats_config[e]["overall_completion"]){q="#CCC"}}p.css("background-color",q);p.text(n.icon_text)}};getProgressbarContext=function(a){var b=$(".parameter_value[field_name='"+window.progress_field_name+"']",a);return{handler:$(".progress",a).parent(),overall_completion:0,sum:parseInt(b.attr("sum")),estimate:parseInt(b.text()),full_stats:b.attr("full_stats")}};setupProgressbar=function(i){var b=getProgressbarContext(i);if(b.sum){if(b.estimate<b.sum){b.handler.addClass("invalidEstimate")}else{b.handler.removeClass("invalidEstimate")}if(b.full_stats&&b.sum){var f=$(".progress tr",b.handler).empty();var h=$("dl",b.handler).empty();var e=0;for(g in window.stats_config){var a=window.stats_config[g];if(a&&a!=1){var c=parseInt(b.full_stats[g]);var d=c/b.estimate*100;if(!isNaN(d)&&d>0){b.overall_completion+=a.overall_completion?d:0;if(e<100){f.append($("<td/>").css("width",(d==Infinity?100:d)+"%").addClass(window.stats_config[g]["css_class"]))}e+=d}h.append($("<dt/>").text(a.label+":")).append($("<dd/>").text(c))}}if(e<100){f.append($("<td/>").css("width",(100-e)+"%"))}b.handler.show();$(".percent",b.handler).text(b.overall_completion.toFixed(0)+"%")}}else{b.handler.hide()}};collapseAllRows=function(){$("th .widget",$("#whiteboard_table")).each(function(){collapseRow($(this))})};collapseRow=function(a){$(".body",a).hide();$(".widget",a.parent().siblings()).each(function(b){var c=$(this);c.addClass("tiny_widget");c.bind("mouseover",function(d){$("#dyn_hint").text($(".title span",c).text()).show().css({display:"block",left:d.pageX+"px",top:d.pageY+25+"px"}).appendTo(document);$(this).one("mouseout",function(f){$("#dyn_hint").hide()})});$(".body, .title > span:not(.ticket-pointer)",c).hide();$(".drag_handle",c).unbind("click")})};expandAllRows=function(){$("th .widget",$("#whiteboard_table")).each(function(){expandRow($(this))})};expandRow=function(a){$(".body",a).show();a.parent().siblings().each(function(b){var d=$(this);$(".draggable",d).each(function(c){var e=$(this);e.removeClass("tiny_widget");e.unbind("mouseover");$(".body, .title > span",e).show()});enableAccordionIfAny(d)})};toggleRowCollapse=function(b){var a=$(".body:visible",b).length>0;if(a){collapseRow(b)}else{expandRow(b)}};toggleControlPanel=function(){$("#wb-sections, #wb-section-info").add($("#wb-panel-button").children()).toggle();return wbContext.toggleControlPanel()};change_ticket_view=function(b,a){$("div.block",b).addClass("hidden");$("div."+a,b).removeClass("hidden");$(".active_tab",b).removeClass("active_tab");$(".views > ."+a,b).addClass("active_tab");$(".body",b).removeClass("hidden");return false};save_ticket=function(a){save_ticket_changes($(a).parents(".widget"),$(a).serialize(),defaultPostprocess)};defaultPrepare=function(f,e){var a=f.attr("idx");var d={ticket:a};var c=getActionToPerform(e.attr("status"),f.attr("status"));if(c){d.tkt_action=c}var b=f.parent();var h=f.remove().draggable(draggable_options);update_cell(b,a);e.append(h);return{ticket:h,data:d}};teamMemberPrepare=function(e,i){var a=e.attr("idx");var c={ticket:a,tkt_action:"reassign",owner:i.attr("owner"),action_reassign_reassign_owner:i.attr("owner")};var d;for(var b in window.groups_config){if(window.groups_config[b]["statuses"]["assigned"]){d=b;break}}var f=e.parent().siblings("td").add(e.parent()).filter('[status="'+d+'"]');update_cell(e.parent(),a);var h=e.remove().draggable(draggable_options);f.append(h);return{ticket:h,data:c}};defaultPostprocess=function(e,d){log("defaultPostprocess",e,d);if(d.result=="done"){var c=d.milestone;var b=e.parent();if(typeof(c)=="undefined"||current_milestone[c]||!e.hasClass("draggable")){for(var a in d){$('[field_name="'+a+'"]',e).text(d[a]);$('[name="field_'+a+'"]',e).val(d[a])}if(d.status){e.attr("status",d.status);$(".parameter[status]",e).addClass("hidden");$(".parameter[status='"+d.status+"']",e).removeClass("hidden")}colorizeWidget(e);removeFromAccordion(e);change_ticket_view(e,"summary")}else{e.remove()}update_cell(b)}};save_ticket_changes=function(b,a,c){c=(typeof(c)=="function")?c:defaultPostprocess;if(typeof(a)=="object"){a.action="change_task"}else{a="action=change_task&"+a}$.getJSON(window.urls.action,a,function(d){c(b,d)})};getActionToPerform=function(d,c){if(typeof(groups_config)=="undefined"){return}var a=groups_config[d];if(a&&!a.statuses[c]){var b=a.transitions;if(b){return b[c]}}};acceptTicket=function(a){return true;if($("[idx='"+a.attr("idx")+"']",this).length>0||!a.hasClass("widget")){return false}var c=a.attr("status");var d=this.attr("status");if(d==a.parent().attr("status")){return true}if(typeof(groups_config)=="undefined"){return false}var b=groups_config[d];if(typeof(b)=="undefined"){return false}return b.transitions[c]};acceptByTeamMember=function(a){var d=window.groups_config;if(typeof(d)=="undefined"){return false}var f=$(this);var e=f.attr("status");var c=a.attr("status");var b=d[e];if(typeof(b)=="undefined"){return false}return b.transitions[c]};toggleTicketsFilter=function(c){var d=$(this);var b=c.data.filterBy;var a=d.parent().parent().attr("filter");wbContext.setFilter(b,a,d.parent().attr(a));filterTickets()};filterTickets=function(){var h="";var d=wbContext.filter.attr;for(var c in d){if(d[c]){h+="["+c+'="'+d[c]+'"]'}$('.active_filter[filter="'+c+'"]').text($('ul[filter="'+c+'"] > li['+c+'="'+d[c]+'"]').eq(0).text())}var b=wbContext.filter.field;for(var e in b){if(b[e]){h+=':has([field_name="'+e+'"]:contains("'+b[e]+'"))'}$('.active_filter[filter="'+e+'"]').text($('ul[filter="'+e+'"] > li['+e+'="'+b[e]+'"]').eq(0).text())}if(h!=""){$(".draggable").filter(h).show();$(".draggable").not(h).hide()}else{$(".draggable").show()}calcAllAggregates()};enableAllAccordions=function(){$(".accordion_support").each(function(a){enableAccordionIfAny(this)})};enableAccordionIfAny=function(a){if($(a).hasClass("accordion_support")){$(".widget",a).each(function(b){putIntoAccordion(this)});$(".widget:last",a).each(function(b){activateAccordionElement(this)})}};putIntoAccordion=function(a){$(".drag_handle",a).bind("click",function(b){activateAccordionElement(b.target)})};removeFromAccordion=function(a){$(".drag_handle",a).unbind("click");$(".body",a).show()};activateAccordionElement=function(c){var b=$(c);var a=b.hasClass("widget")?b:b.parent();$(".body",a.siblings()).hide();a.removeClass("tiny_widget");$(".body",a).show();change_ticket_view(a,"summary")};createDropFunction=function(a,b){return function(d,e){var c=a($(e.draggable),$(this));save_ticket_changes(c.ticket,c.data,b)}};make_droppable=function(c,a,b,d){c.droppable({accept:a,activeClass:"droppable-active",hoverClass:"droppable-hover",drop:createDropFunction(b,d)})};bindEventHandlers=function(){$("a",$("#wb-section2")).bind("click",{filterBy:"field",selector:"#wb-section-info-members"},toggleTicketsFilter);$("a",$("#wb-section4")).bind("click",{filterBy:"attr"},toggleTicketsFilter);$("th .widget .title",$("#whiteboard_table")).bind("click",function(){toggleRowCollapse($(this).parent())});$("th.first-item",$("#whiteboard_table")).bind("click",function(){var a=$(this);a.toggleClass("active");if(a.hasClass("active")){expandAllRows()}else{collapseAllRows()}});$("#wb-panel-button").bind("click",toggleControlPanel)};enableDragAndDrop=function(){$(".item-droppable",$("#wb-section2")).droppable({accept:acceptByTeamMember,hoverClass:"item-droppable-active",drop:createDropFunction(teamMemberPrepare)});$(".draggable").draggable(draggable_options)};colorizeWidgets=function(){$(".widget").each(function(a){colorizeWidget($(this))})};setupAjax=function(){$("#wb-error-panel").ajaxError(function(c,b,a){$(this).append("<li>Error performing action: "+a.url+"</li>")});rpc=$.rpc(window.urls.rpc,"xml",function(a){if(!a||!a.system){alert("Could not get the rpc object ..");return}})};loadContext=function(){wbContext.load();filterTickets();if(wbContext.cpVisible=="true"){wbContext.cpVisible=false;toggleControlPanel()}};modifyMilestonesTree=function(){var a=$("#mils_options");a.bind("submit",function(){$(":checkbox:checked",a).prev().remove()});$(":checkbox",a).bind("change",function(){a.trigger("submit")})};setupTicketCreation=function(){var b=$("#new_ticket_template");function a(){var e=b.clone().attr("id","new_ticket_prototype").appendTo($("#hidden_container"));$(".summary .parameter:has([field_name='summary'],[field_name='description'], [field_name='type'])",e).remove();$(".edit .parameter:has([name='field_summary'],[name='field_description'], [name='field_type'])",e).remove()}function d(l,i){defaultPostprocess(l,i);if(i.result=="done"){var f=$(".title a",l);var e=f.attr("href");var k=i.id;l.attr({idx:k,id:"ticket_"+k});var j=e;var h="";if(e.indexOf("?")>0){j=e.substring(0,e.indexOf("?"));h=e.substring(e.indexOf("?")+1)}e=j.substring(0,j.length-3)+k+(h!=""?"?"+h:"");f.attr("href",e).text("#"+k);f.parent().next().text(i.summary);$(':hidden[name="ticket"]',l).val(k);l.draggable(draggable_options);contextMenu.attachTo($(".ticket-pointer",l))}}function c(){function f(){$.fn.colorbox.close();return false}var e=$('<a class="append_button" href="'+window.urls.popup+'tickets" title="Create Ticket">Add Ticket</a>').click(function(){var h=$(this);window.popup_context={cancel:f,setup:function(i){var j;for(mil in window.current_milestone){j=mil;break}$("[name='field_milestone']",i).val(j)},done:function(k){log("popup reports that action was done",k);k.result="done";var i=popup_context.new_story;if(isNaN(parseInt(i))){i=""}var j=$("#new_ticket_prototype .widget").clone().attr("ticket_type",k.type).appendTo($('#whiteboard_table tbody tr[idx="'+i+'"] > td[status]:first'));$(".progress",j).parent().remove();$('[field_name="description"]',j).text(k.description);log("before enabling drag and drop",j);j.addClass("draggable").draggable(draggable_options);rpc.ticketconfig.trace(function(l){d(j,k)},k.id,i);return f()}};popup_context.new_story=h.parents(".group_holder").attr("idx");$.fn.colorbox({href:window.urls.popup+"tickets",open:true,title:"Create Ticket"});return false});$($("<li/>").append(e)).appendTo($("#whiteboard_table tbody th .views"))}if(b.length>0){a();c()}};function showPopup(d,c){function a(){$.fn.colorbox.close();return false}var b=$("#ticket_"+d);if(b.length>0){window.popup_context={cancel:a,setup:function(e){},done:function(e){log("popup reports that action was done",e);e.result="done";defaultPostprocess(b,e);return a()}};$.fn.colorbox({href:window.urls.popup+c+"/"+d,open:true,title:"Edit Ticket"})}}function showQuickEditor(a){showPopup(a,"tickets")}function showCommentEditor(a){showPopup(a,"comment")}function showFullEditor(a){document.location=window.urls.base+"/ticket/"+a}function ContextMenu(){jQuery("body").append('<div id="inline-menu"><div id="inline-menu-body"></div></div>');var b=jQuery("#inline-menu");var e=jQuery("#inline-menu-body");function a(f){log("element",f,jQuery(f));offset=jQuery(f).offset();b.css("left",offset.left);b.css("top",offset.top);menuItems=d(f);if(menuItems){e.html("<div>"+jQuery(f).outerHTML()+"</div>"+menuItems);b.show()}}function d(f){var h=jQuery(f).text().substr(1);if(jQuery(f).hasClass("ticket-pointer")){menu="<ul>";menu+='<li class="inline-menu-item-ticket-quick-editor"><a href="#quickeditor" onclick="showQuickEditor(\''+h+"')\">Quick Editor</a></li>";menu+='<li class="inline-menu-item-ticket-comment"><a href="#comment" onclick="showCommentEditor(\''+h+"')\">Comment</a></li>";menu+='<li class="inline-menu-item-ticket-full-editor"><a href="#fulleditor" onclick="showFullEditor(\''+h+"')\">Full Editor</a></li>";menu+="</ul>"}return menu}function c(f){$(f).mouseover(function(){a(this)})}this.attachTo=c;c(jQuery(".ticket-pointer"));jQuery(b).hover(function(f){},function(f){jQuery(b).hide()})}$(document).ready(function(){setupAjax();bindEventHandlers();enableAllAccordions();enableDragAndDrop();colorizeWidgets();modifyMilestonesTree();setupTicketCreation();contextMenu=new ContextMenu();loadContext()});