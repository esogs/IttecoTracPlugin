(function(a){a.fn.extend({whiteboard:function(f,d){var o=a(this);var u=o.get(0);function e(){}if(!window.console){window.console={log:e}}if(typeof f=="string"){var c=Array.prototype.slice.call(arguments,1);var w=a.data(document,"whiteboard"+o.attr("id"))[f].apply(this,c);if(w!=undefined){return w}return this}var b,p=false;var n={managersQuantity:2,managers:{},reportReady:function(x){g("manager "+x.name+" reported that it is ready");this.managers[x.name]=x;var i=0;for(m in this.managers){i=i+1}if(i==this.managersQuantity){p=true;g("all managers ready. notifying.",this.listeners);if(typeof this["listeners"]!="undefined"){for(idx in this.listeners){g("notify listener "+idx);this.listeners[idx]()}}}},addListener:function(i){if(typeof this["listeners"]=="undefined"){this["listeners"]=[]}this.listeners.push(i)},tzoffset:new Date().getTimezoneOffset(),debug:false};var k={delay:5000,rpcurl:"/login/xmlrpc",baseurl:"",timerurl:"",debug:false,scopeitem:{types:["story","enhancement"],weight:"business_value",weightlabel:"BV"},workitem:{types:"*",weight:"complexity",weightlabel:"CP"},groups:[{name:"Planning",status:["new","reopened"]},{name:"In Progress",status:["assigned","accepted"]},{name:"Done",status:["closed"],overall_completion:true}],transitions:[{newstatus:"assigned",oldstatuses:["new","assigned","reopened"],action:"reassign"},{newstatus:"reopened",oldstatuses:["closed"],action:"reopen"}],avatarResolver:function(x,i){return x.baseurl+"/chrome/itteco/images/avatar.png"}};var t=a.extend(k,{});for(var r=1;r<arguments.length;r++){t=a.extend(t,arguments[r])}function g(){if(typeof window.console=="undefined"){window.console={log:function(){}}}if(t.debug){console.log.apply("",arguments)}}var s={},q={};function l(){a.each(t.groups,function(x,y){a.each(y.status,function(A,z){s[z]=y.name});q[y.name]={}});var i;a.each(t.transitions,function(x,y){if(y.newstatus=="*"){i=y.action}a.each(y.oldstatuses,function(A,z){var B=s[y.newstatus];if(typeof B!="undefined"){q[B][z]=y.action}})});if(i!=undefined){a.each(t.groups,function(x,y){a.each(y.status,function(A,z){q[y.name][z]=i})})}g("transitionMatrix",q)}l();function h(){this.name="transport";var x=this;g("init TransportManager with ",t.rpcurl);a.rpc(t.rpcurl,"xml",function(y){if(!y||!y.system){g("Could not get the rpc object ...");return}x.proxy=y;n.reportReady(x)});this.isReady=function(){return(typeof proxy=="undefined")};function i(y){return function(z){g("responseHandler",z,z.faultString);if(z&&z.error){alert(z.error.faultString)}else{y(z.result)}}}}function j(){this.name="tickets";g("init ticket manager");var C,z,I,H,G;function E(){C={};z={};I=new K();o.empty();H=new B();G=new A()}E();function x(M){return(f.owner=="all"||M.owner==f.owner)&&(f.ticket_type=="all"||M.type==f.ticket_type)}function L(N){var M=N.type;if(typeof M=="undefined"){return false}return t.scopeitem.types.indexOf(M)!=-1}function D(N,M){N.$local$uid=M;N.groupItems={};N.progress=new K(I);N.remove=function(O){var P=s[O.status];if(typeof P!="undefined"){g("removing ",O,"from group "+P+" of story",N);N.groupItems[P]=N.groupItems[P].filter(function(R,Q,S){if(R.id==O.id){N.progress.dec(P,O[t.workitem.weight])}return R.id!=O.id})}else{g("failed to define group for ticket",O,"ignoring")}};N.add=function(P,Q){g("story.add",P,"to group "+Q);var O=z[P.id];if(typeof O!="undefined"){this.remove(O)}z[P.id]=P;P.story=N;if(typeof Q=="undefined"){Q=s[P.status]}if(typeof Q!="undefined"){N.progress.inc(Q,P[t.workitem.weight]);g("pushing",P,"to group "+Q+" for story",N);N.groupItems[Q].push(P)}else{g("failed to define group for ticket",P,"ignoring")}};a.each(t.groups,function(O,P){N.groupItems[P.name]=[]})}function B(){function R(){var Y=a(".w-whiteboard-summary",o);if(Y.length==0){Y=a('<div class="w-whiteboard-summary"></div>').prependTo(o)}Y.empty();var Z=I.info();a.each(Z.intervals,function(aa,ab){Y.append(ab.label+": ").append('<span class="value">'+ab.absvalue+" "+t.workitem.weightlabel+"</span>").append("<span>|</span>")})}function M(aa,Z,Y){Z.unbind().click(function(ab){if(aa.hasClass("w-widget-collapsed")){Y.slideDown()}else{Y.slideUp()}aa.toggleClass("w-widget-collapsed")});if(aa.hasClass("w-widget-collapsed")){Y.hide()}}function V(Z,Y){Z.draggable("destroy").draggable({helper:"clone",handle:Y,start:function(ab,aa){a(aa.helper).width(Z.width())},stop:function(){}})}function S(Y){a(".w-ticket",Y).hover(function(){var Z=a(this);Z.addClass("hover");setTimeout(function(){if(Z.hasClass("hover")){Z.find(".s-icon-bar").fadeIn()}},500)},function(){var Z=a(this);Z.removeClass("hover");a(this).find(".s-icon-bar").fadeOut("fast")});a(Y).hover(function(){var Z=a(this);Z.addClass("hover");setTimeout(function(){if(Z.hasClass("hover")){Z.find(".w-story-summary .s-icon-bar").fadeIn()}},500)},function(){var Z=a(this);Z.removeClass("hover");a(this).find(".w-story-summary .s-icon-bar").fadeOut("fast")})}function Q(Z,Y,aa){Z.droppable("destroy").droppable({accept:function(ab){return N(ab,aa)},hoverClass:"item-droppable-active",drop:function(ad,ab){g("dropping ticket to group "+aa);var ac=T(ab.draggable);setTimeout(function(){var ae=ac.story;ae.remove(ac);Y.add(ac,aa);U(ae);var af={action:q[aa][ac.status]};if(f.board=="stories"){af.milestone=Y.id}i(ac,af,true);if(ae!=Y){if(f.board!="stories"){n.managers.transport.proxy.ticketconfig.trace(e,ac.id,Y.id||"",ae.id||"")}U(Y)}},200)}})}function T(Y){var aa=Y.attr("id");var Z=aa.substr("ticket-widget-".length);return z[Z]}function N(Z,ab){var aa=T(Z);var Y=q[ab][aa.status];return typeof Y!="undefined"}function W(ab,Y,ac){var Z=L(ab)||(ac!=undefined&&f.board=="stories");if(typeof ac=="undefined"){ac=""}var aa=a('<div class="s-columns w-ticket-toolbar '+ac+'"><div class="s-column-left">'+(ab.id?'<div class="s-avatar-wrapper s-avatar-wrapper-20"><img class="s-avatar" width="20" height="20" alt="'+ab.owner+'" title="'+ab.owner+'" src="'+t.avatarResolver(t,ab.owner)+'" /></div><div class="w-ticket-values">'+(ab[t.scopeitem.weight]||"0")+" <em>"+t.scopeitem.weightlabel+"</em>"+(t.scopeitem.weight!=t.workitem.weight?("  <span>|</span> "+(ab[t.workitem.weight]||"0")+" <em>"+t.workitem.weightlabel+"</em>"):"")+" </div>":"")+"</div></div>").append(a('<div class="w-column-right">').append(a('<ul class="s-icon-bar">'+(ab.id?'<li><a href="'+t.baseurl+"/popup/"+Y+"/"+ab.id+'" class="s-icon-button s-icon s-icon-edit-quick">View</a></li>':"")+(ab.id?'<li><a href="'+t.baseurl+"/"+Y+"/"+ab.id+'" class="s-icon-button s-icon s-icon-edit">Edit</a></li>':"")+(ab.id?'<li><a href="'+t.baseurl+"/popup/comment/"+Y+"/"+ab.id+'" class="s-icon-button s-icon s-icon-comments">Comments</a></li>':"")+(Z?'<li><a href="#" class="s-icon-button s-icon s-icon-ticket-add">Add ticket</a></li>':"")+(ab.id&&!Z&&t.timerurl!=""?'<li><a href="'+t.timerurl+"?title="+encodeURIComponent("#"+ab.id+" "+ab.summary)+'" class="s-icon-button s-icon s-icon-timetrack" title="Time Track">Time Track</a></li>':"")+"</ul>")));a(".s-icon-ticket-add",aa).click(function(){G.createNewTicket(ab);return false});a(".s-icon-comments",aa).click(function(){G.comment(ab,this);return false});a(".s-icon-edit-quick",aa).click(function(){G.edit(ab,this);return false});a(".s-icon-timetrack",aa).click(function(){G.popup(this);return false});return aa}function O(ab,Z){var ac;if(typeof Z=="undefined"){Z=""}var aa=a('<div id="ticket-widget-'+ab.id+'" class="w-ticket w-ticket-'+ab.type+" s-widget-nofx "+Z+'">').append(ac=a('<div class="w-ticket-header"><h6><span class="w-ticket-type w-ticket-type-'+ab.type+'" title="'+ab.type.substring(0,1).toUpperCase()+ab.type.substring(1)+'">'+ab.type.substring(0,1).toUpperCase()+'</span><span class="w-ticket-number"><a href="'+t.baseurl+"/ticket/"+ab.id+'">#'+ab.id+"</a></span>&nbsp;"+ab.summary+"</h6></div>"));var Y=a('<div class="w-ticket-body"><div class="w-ticket-description">'+ab.description+"</div></div>");Y.append(W(ab,t.workitem.realm));aa.append(Y);M(aa,ac,Y);V(aa,ac);return aa}function U(ag){var ac="story-widget-"+ag.$local$uid;var ab=a("#"+ac,o);if(ab.length>0){ab.empty()}else{o.append(ab=a('<div id="'+ac+'" class="s-block w-story s-widget-collapsible s-widget-nofx"/>'))}var aa,ad,af;ab.append(aa=a('<div class="s-block-header s-widget-handler"/>')).append(ad=a('<div class="s-block-body s-widget-body"></div>').append(af=a('<div class="w-story-sections"/>')));aa.append(P(ag.progress)).append('<h4 class="w-widget-collapsible-handler">'+(ag.id&&ag.id!=ag.summary?"#"+ag.id:"")+"&nbsp;"+ag.summary+"</h4>");var Z=a('<div class="w-story-section"/>').append(W(ag,t.scopeitem.realm,"w-story-summary")).append(a('<div class="w-story-description">'+(ag.description||"")+"</div>"));var ae=Z.height();af.append(Z);a.each(t.groups,function(ak,aj){var ai=a('<div class="w-story-section"><h5 class="w-story-section-header">'+aj.name+"</h5>");af.append(ai);var ah=aj.accordion=="true"?"w-widget-collapsed":"";a.each(ag.groupItems[aj.name],function(al,am){if(x(am)){ai.append(O(am,ah))}});Q(ai,ag,aj.name);ae=Math.max(ae,ai.height())});var Y=90/af.children().length+"%";af.children().each(function(){a(this).css({width:Y,"min-height":ae})});M(ab,aa,ad);S(ab);R()}function P(Y){var aa,Z;var ab=Y.info();if(isNaN(ab.done)){return""}aa=a('<div class="t-story-progress"/>');aa.append(Z=a('<div class="t-progress-bar"/>'));g("rendering progress bar for info",ab);a.each(ab.intervals,function(ac,ad){Z.append('<div class="t-progress-bar-item t-progress-bar-item-'+ad.name+'" style="width: '+ad.percentage+'%;"></div>')});aa.append("<span>"+ab.done+"%</span>");return aa}function X(){var Y={path:"",settings_file:encodeURIComponent(t.baseurl+"/whiteboard/chart_settings/"+f.milestone)};swfobject.embedSWF(t.baseurl+"/chrome/itteco/charts/amstock/amstock.swf",o.attr("id"),"100%","400","9.0.0","expressInstall.swf",Y)}this.renderBurndown=X;this.makeCollapsable=M;this.createTicketToolbar=W;this.createTicketWidget=O;this.renderScopeElement=U;this.renderWhiteboardSummary=R}function K(M){var Q={};var N=0;var P=[];a.each(t.groups,function(S,T){Q[T.name]=0;if(T.overall_completion){P.push(T.name)}});function O(T){if(typeof T=="undefined"){return 0}try{return new Number(T)}catch(S){g("failed to transform to number",S,"returning 0.")}return 0}function R(U,T){var S=Q[U];if(typeof S=="undefined"){S=0}Q[U]=S+T;N=N+T;if(typeof M!="undefined"){M.change(U,T)}}this.change=R;this.inc=function(T,S){R(T,O(S))};this.dec=function(T,S){R(T,-1*O(S))};this.info=function(){var T=[];a.each(t.groups,function(U,V){T.push({name:V.name.toLowerCase().replace(" ",""),label:V.name,absvalue:Q[V.name],percentage:Q[V.name]/N*100})});var S=0;a.each(P,function(U,V){S+=Q[V]});return{intervals:T,done:Math.round(S/N)}}}function A(){function O(){a.fn.colorbox.close();return false}function M(S){a.fn.colorbox({href:S,open:true})}function P(S){window.popup_context={cancel:O,setup:function(U){var W=(f.board=="stories")?S.summary:f.milestone;var T=a("[name='field_milestone']",U);T.val(W);if(T.length>0){var V=T.get(0);if(typeof V.refresh=="function"){V.refresh()}}a("[name='field_type']",U).val(t.workitem.types[0])},done:function(T){g("popup reports that action was done",T);var U=S.id;if(typeof U=="undefined"){U=""}n.managers.transport.proxy.ticketconfig.trace(function(V){if(L(T)){H.renderScopeElement(T)}else{S.add(T);H.renderScopeElement(S)}},T.id,U);return O()}};M(t.baseurl+"/popup/ticket")}function R(T,S){window.popup_context={cancel:O,setup:function(U){},done:function(U){g("popup reports that action was done",U);return O()}};M(S.href)}function Q(T,S){window.popup_context={cancel:O,setup:function(){},done:function(V){g("popup reports that action was done",T);var U=T.story;U.add(V);H.renderScopeElement(U);return O()}};M(S.href)}function N(S){M(S.href)}this.createNewTicket=P;this.comment=R;this.edit=Q;this.popup=N}function F(){g("reading out tickets for context",f);n.managers.transport.proxy.whiteboard.query(function(M){g("Whiteboard query results:",M);a.each(M.result,function(O,N){D(N,O);if(typeof N.references!="undefined"){a.each(N.references,function(P,Q){N.add(Q)})}C[N.id]=N});y()},f)}function i(O,N,M){n.managers.transport.proxy.ticket.update(function(S){g("Ticket update results:",S);if(S.result){var R=S.result[0],Q=S.result[3];Q.id=R;Q.story=O.story;z[""+R]=Q;if(M){var P=O.story;P.add(Q);H.renderScopeElement(P)}}},O.id,"",N)}function y(){a.each(C,function(N,M){H.renderScopeElement(M)})}function J(){if(f.board=="burndown"){H.renderBurndown()}else{F()}}n.addListener(J);n.reportReady(this);this.reset=E;this.init=J;this.readTickets=F;this.renderStories=y}new h();new j();var v={reset:function(){if(p){n.managers.tickets.reset();n.managers.tickets.init()}},redraw:function(){if(p){n.managers.tickets.renderStories()}}};a.data(document,"whiteboard"+o.attr("id"),v);return this},outerHTML:function(){return a("<div>").append(this.eq(0).clone()).html()}})})(jQuery);