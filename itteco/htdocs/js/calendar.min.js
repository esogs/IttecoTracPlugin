(function(a){a.fn.eventCalendar=function(l){var c=a.extend({},a.fn.eventCalendar.defaults,{target:this},l);var k={managersQuantity:4,managers:{},reportReady:function(o){this.managers[o.name]=o;var n=0;for(m in this.managers){n=n+1}if(n==this.managersQuantity){if(typeof this["listeners"]!="undefined"){for(idx in this.listeners){this.listeners[idx]()}}}},addListener:function(n){if(typeof this["listeners"]=="undefined"){this["listeners"]=[]}this.listeners.push(n)},tzoffset:new Date().getTimezoneOffset(),debug:false};function h(){if(a.isFunction(c.renderCallback)){c.renderCallback()}}window.popup_context={};function d(){if(c.debug&&typeof(console)!="undefined"&&console.log){console.log.apply(console,arguments)}}d("pre init",this,l,c);function i(){this.name="transport";var o=this;d("init TransportManager with ",c.systemUrl);a.rpc(c.systemUrl,"xml",function(q){if(!q||!q.system){d("Could not get the rpc object ...");return}o.proxy=q;k.reportReady(o)});this.isReady=function(){return(typeof proxy=="undefined")};function n(q){return function(r){d("responseHandler",r,r.faultString);if(r&&r.error){alert(r.error.faultString)}else{q(r.result)}}}}function f(){this.name="calendars";var q,z={};var o=new w();var r={my:a(c.my),shared:a(c.shared)};function w(){this.name="theme";var J=this;var H,E,I,C,G,F;a("body").append(H=a('<div class="c-menu" style="display:none;">').append(E=a('<ul id="theme-selector" class="c-menu-colors"/>')));for(var D=0;D<21;D++){E.append(a('<li><a href="#" class="c-color'+D+'" theme="'+D+'">#</a></li>'))}H.append(I=a('<ul class="c-menu-actions">').append(C=a('<li class="c-menu-item-delete"><a href="#">Delete</a></li>')).append(G=a('<li><a href="#">Share</a></li>')).append(F=a('<li><a href="#">Edit</a></li>')));this.attach=function(L,K,O){d("attaching calendar menu",K);var N=a(L);var M=N.offset();H.hide().css("top",M.top).css("left",M.left-H.width()).fadeIn(250);E.find("li > a").unbind().click(function(){x(K,a(this).attr("theme"));J.hide();return false});a("a",F).unbind().click(function(){function Q(){}function P(){a.fn.colorbox.close();J.hide();return false}popup_context={setup:Q,cancel:P,done:function(R){s(R);return P()}};a.fn.colorbox({href:c.rootUrl+"/popup/calendars/"+K.id,open:true,title:"Calendar Data"})});if(K.own){C.show();G.show();a("a",C).unbind().click(function(){v(K);J.hide();return false});a("a",G).unbind().click(function(){K.type="S";y(K);J.hide();return false})}else{C.hide();G.hide()}a(document).one("click",function(){H.hide()});H.show();return false};this.hide=function(){E.find("li > a").andSelf().unbind();H.hide()}}d("init CalendarsManager",r);function A(){a(".s-icon-calendar-add").click(function(){function D(){}function C(){a.fn.colorbox.close();return false}popup_context={setup:D,cancel:C,done:function(E){s(E);return C()}};a.fn.colorbox({href:c.rootUrl+"/popup/calendars/",open:true,title:"Calendar Data"})})}function s(C){var D=[];D.push(C);t(D);n();k.managers.events.rerenderEvents(C.id)}function u(){k.managers.transport.proxy.calendar.query(function(C){d("getCalendars-result:",C);t(C.result);n();k.managers.events.init()})}function v(D){function C(E){delete z[E];n();k.managers.events.rerenderEvents()}if(typeof D.pid!="undefined"){C(D.pid);return}k.managers.transport.proxy.calendar.remove(function(){C(D.id)},D.id)}function y(C){k.managers.transport.proxy.calendar.save(function(F){if(typeof C.pid!="undefined"){delete z[C.pid]}d("saveCalName-resp",F);var E=[],D=F.result;E.push(D);t(E);n();k.managers.events.rerenderEvents(D.id)},C.id||"",C.name,C.theme,C.type,C.ref||0)}function B(){a.each(z,function(){if(this.type=="R"){var C=z[this.ref];C.theme=this.theme;C.disabled=false}})}function t(C){a.each(C,function(){this.disabled=!this.own;z[this.id]=this});B()}function x(E,D){if(E.theme==D){return}var F,C;if(!E.own){C="R";a.each(z,function(){if(this.type=="R"&&this.ref==E.id){F=this;return true}})}else{F=E;C=F.type}y({id:(F&&F.id)||"",name:E.name,type:C,theme:D,ref:E.id})}function n(){for(var C in r){r[C].empty()}a.each(z,function(){var H=this;if(H.type=="R"){return true}var D=H.own?r.my:r.shared;if(!q&&H.own){q=H}var G,F,E;D.append(G=a('<li id="calendar_'+this.id+'" class="calendar-line c-color'+this.theme+(this.disabled?" c-non-selected":" c-selected")+(q===H?" calendar-editable":"")+'"></li>').append(E=a('<a href="#" class="c-mlink">#</a>')).append(F=a("<span>"+this.name+"</span>")));F.click(function(){G.toggleClass("c-selected").toggleClass("c-non-selected")});E.unbind().click(function(){var I=a(this);o.attach(I,H);return false})});h()}this.read=u;this.getCalendar=function(){if(arguments.length==0){return q}return z[arguments[0]]};A();k.addListener(u);k.reportReady(this)}function e(){var o=[];var n=[];this.push=function(){function s(){}if(arguments.length>0){var r=arguments.length-1;var q=arguments[r];if(typeof q!="function"){q=s}else{r=r-1}if(arguments.length>1){n.push({methodName:arguments[0],params:a.grep(arguments,function(u,t){return t!=0&&t<=r})})}o.push(q)}};this.call=function(){k.managers.transport.proxy.system.multicall(function(s){var r=s.result,q=s.result.length;a.each(o,function(t,v){var u;if(t<q){u=r[t][0][3]}v(u)})},n)}}function g(){this.name="tickets";var n={};function q(){var w,v=this;a("body").append(w=a('<div class="t-menu" style="display:none;"><ul class="s-icon-bar"><li><a href="#" class="s-icon-button s-icon s-icon-comments" title="Comments">Comments</a></li><li><a href="#" class="s-icon-button s-icon s-icon-edit" title="Full view/edit">Edit</a></li><li><a href="#" class="s-icon-button s-icon s-icon-edit-quick" title="Quick view/edit">View</a></li><li><a href="#" class="s-icon-button s-icon s-icon-create-event" title="Create event for this ticket">&#x00AB;</a></li></ul></div>'));this.attach=function(A,z){d("attaching ticket menu",z);var C=a(A);var B=C.offset();w.hide().css("top",B.top).css("left",B.left-w.width()).fadeIn(250);w.find("li > a").unbind();function y(){}function x(){a.fn.colorbox.close();v.hide();return false}a(".s-icon-edit",w).attr("href",c.rootUrl+"/ticket/"+z.id);a(".s-icon-comments",w).click(function(){popup_context={setup:y,cancel:x,done:x};a.fn.colorbox({href:c.rootUrl+"/popup/comment/"+z.id,open:true,title:"Comment Ticket"})});a(".s-icon-edit-quick",w).click(function(){popup_context={setup:y,cancel:x,done:x};a.fn.colorbox({href:c.rootUrl+"/popup/tickets/"+z.id,open:true,title:"Edit Ticket"})});a(".s-icon-create-event",w).click(function(){popup_context={setup:y,cancel:x,done:function(F){k.managers.events.renderEvent(F);return x()}};var E=k.managers.calendars.getCalendar();var D=E&&E.id||"";a.fn.colorbox({href:c.rootUrl+"/popup/events/?calendar="+D+"&ticket="+z.id+"&date="+(Math.ceil(new Date().getTime()/30/60/1000)*30*60),open:true,title:"Create Event"})});a(document).one("click",function(){w.hide()});w.show();return false};this.hide=function(){w.hide()}}var t=new q();d("init TicketsManager");function u(){a(".s-icon-ticket-add").unbind().click(function(){function w(){}function v(){a.fn.colorbox.close();return false}popup_context={setup:w,cancel:v,done:function(x){n[x.id]=x;r(a(c.tickets),x);return v()}};a.fn.colorbox({href:c.rootUrl+"/popup/ticket/",open:true,title:"Create Ticket"})})}function o(){k.managers.transport.proxy.ticketconfig.my_active_tickets(function(w){var v=new e();a.each(w.result,function(x,z){d("read-ticket-header",z);var y=z.ticketId;v.push("ticket.get",y,function(A){A.id=y;n[y]=A})});v.push(s);v.call()})}function r(v,x){var y,w;v.append(y=a('<li id="ticket_'+x.id+'"/>').append(w=a('<a href="#" class="c-mlink">#</a>')).append('<span><strong><a href="'+c.rootUrl+"/ticket/"+x.id+'">#'+x.id+"</a></strong> "+x.summary+"</span>"));w.click(function(){t.attach(this,x);return false})}function s(){var v=a(c.tickets);a.each(n,function(x,w){r(v,w)});h()}u();k.addListener(o);k.reportReady(this)}function b(){this.name="events";var u;function t(w){return Math.round(w.getTime()/1000)}function v(w,y){if(typeof y=="undefined"){y={}}for(p in w){y[p]=w[p]}if(typeof(w.start)!="object"){y.start=a.fullCalendar.parseISO8601(w.start||"",false)}if(typeof(w.end)!="object"){y.end=a.fullCalendar.parseISO8601(w.end||"",false)}y.title=w.name;var x=k.managers.calendars.getCalendar(w.calendar);if(x){if(x.type!="R"){y.editable=true}y.className=["c-color"+x.theme,(w.timetrack?" timetrac-enabled":""),(w.ticket&&w.ticket>0?" ticket-reference":"")]}d("mapped-event",y,w);return y}function s(z,w,y){var x=[];k.managers.transport.proxy.event.query(function(A){d("events-resp",A);a.each(A.result,function(){x.push(v(this))});y(x)},t(z),t(w),k.tzoffset)}function r(w){k.managers.transport.proxy.event.save(function(x){n(x.result)},w.id,w.calendar,w.title,w.allDay,w.start,w.end,w.description,w.ticket,w.timetrack,w.auto,w.time,k.tzoffset)}function n(w){var x=u.fullCalendar("clientEvents",w.id);if(x){x=x[0]}x=v(w,x);u.fullCalendar("renderEvent",x);x.source=s}function q(){function x(){}function w(){a.fn.colorbox.close();return false}popup_context={setup:x,cancel:w,done:function(y){n(y);return w()}}}function o(){d("rendering fullCalendar",c.target);u=a(c.target).fullCalendar({editable:false,disableDragging:false,disableResizing:false,firstHour:8,header:{left:"prev,next today",center:"title",right:"month,agendaWeek,agendaDay"},eventRender:function(z,x,w){var y=k.managers.calendars.getCalendar(z.calendar);return(y&&!y.disabled)},loading:function(w){if(w){a("#loading").show()}else{a("#loading").hide()}},dayClick:function(w,B,y,x){q();var A=k.managers.calendars.getCalendar();var z=A&&A.id||"";a.fn.colorbox({href:c.rootUrl+"/popup/events/?allDay="+B+"&calendar="+z+"&date="+t(w),open:true,title:"Create Event"})},eventClick:function(y,x,w){q();a.fn.colorbox({href:c.rootUrl+"/popup/events/"+y.id,open:true,title:"Edit Event"})},eventDrop:function(D,z,y,C,A,x,B,w){d("eventDrop",D,z,y,C);r(D)},eventResize:function(C,z,y,A,x,B,w){r(C)},viewDisplay:function(w){h()}})}this.renderEvent=n;this.rerenderEvents=function(w){d("rerenderEvents",w);if(w){a.each(u.fullCalendar("clientEvents",function(x){return x.calendar==w}),function(x,y){u.fullCalendar("updateEvent",v(y,y))})}u.fullCalendar("rerenderEvents")};this.init=function(){o();u.fullCalendar("addEventSource",s)};k.reportReady(this)}function j(){a(".fc-view td").droppable({accept:"#demo",tolerance:"pointer",hoverClass:"droppable-hover",over:function(){d("over",this);this.old_bg=a(this).css("backgound");a(this).css("background","#90e224 url(./../images/droppable-hover.png) 0 0")},out:function(){d("out",this);a(this).css("background",this.old_bg)},drop:function(){d("drop")}});a(".help").click(function(){var n=fullCalendar.fullCalendar("getView");d("view",n);n.reportEventElement({_id:"ticket_1"},a("#ticket_1"));n.draggableEvent({_id:"ticket_1"},a("#ticket_1"))})}new i();new f();new g();new b()};a.fn.eventCalendar.defaults={my:"#my-calendars",shared:"#shared-calendars",tickets:"#tickets",debug:false}})(jQuery);