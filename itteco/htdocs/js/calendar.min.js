(function(a){a.fn.eventCalendar=function(n){var c=a.extend({},a.fn.eventCalendar.defaults,{target:this},n);var l={managersQuantity:5,managers:{},reportReady:function(q){this.managers[q.name]=q;var o=0;for(m in this.managers){o=o+1}if(o==this.managersQuantity){if(typeof this["listeners"]!="undefined"){for(idx in this.listeners){this.listeners[idx]()}}}},addListener:function(o){if(typeof this["listeners"]=="undefined"){this["listeners"]=[]}this.listeners.push(o)},tzoffset:new Date().getTimezoneOffset(),debug:true};function h(){if(a.isFunction(c.renderCallback)){c.renderCallback()}}window.popup_context={};function e(){if(c.debug&&typeof(console)!="undefined"&&console.log){console.log.apply(console,arguments)}}e("pre init",this,n,c);function k(){this.name="theme";var u=this;var t,o;a("body").append(t=a('<ul id="theme-selector" class="theme-selector" style="position:absolute;display:none;"/>'));for(var s=0;s<7;s++){t.append(a('<li class="event-theme-'+s+'" theme="'+s+'"><div class="toggler">&nbsp;</div></li>'))}function r(){o=setTimeout(function(){u.hide()},500)}function q(){clearTimeout(o)}this.attach=function(w,v,y){var x=a(w);x.one("mouseleave",function(){r()});t.bind("mouseenter",function(){q()}).bind("mouseleave",function(){r()});t.find("li").click(function(){y(a(this).attr("theme"));u.hide()});t.css({top:x.offset().top,left:x.offset().left}).show()};this.hide=function(){t.find("li").andSelf().unbind();t.hide()};l.reportReady(this)}function i(){this.name="transport";var q=this;e("init TransportManager with ",c.systemUrl);a.rpc(c.systemUrl,"xml",function(r){if(!r||!r.system){e("Could not get the rpc object ...");return}q.proxy=r;l.reportReady(q)});this.isReady=function(){return(typeof proxy=="undefined")};function o(r){return function(s){e("responseHandler",s,s.faultString);if(s&&s.error){alert(s.error.faultString)}else{r(s.result)}}}}function f(){this.name="calendars";var r,y={};var s={my:a(c.my),myShared:a(c.myShared),shared:a(c.shared)};e("init CalendarsManager",s);function q(B){if(typeof B=="undefined"){B="P"}return{pid:new Date().getTime(),type:B,name:"&lt;change me&gt;",theme:1,own:true,ref:0}}function t(){var C;s.my.before(C=a('<a href="#add">add</a>'));function B(D){return function(){var E=q(D);y[E.pid]=E;o()}}C.click(B("P"));s.myShared.before(C=a('<a href="#add">add</a>'));C.click(B("S"))}function v(){l.managers.transport.proxy.calendar.query(function(B){e("getCalendars-result:",B);u(B.result);o();l.managers.events.init()})}function w(C){function B(D){delete y[D];o();l.managers.events.rerenderEvents()}if(typeof C.pid!="undefined"){B(C.pid);return}l.managers.transport.proxy.calendar.remove(function(){B(C.id)},C.id)}function z(B){l.managers.transport.proxy.calendar.save(function(E){if(typeof B.pid!="undefined"){delete y[B.pid]}e("saveCalName-resp",E);var D=[],C=E.result;D.push(C);u(D);o();l.managers.events.rerenderEvents(C.id)},B.id||"",B.name,B.theme,B.type,B.ref||0)}function A(){a.each(y,function(){if(this.type=="R"){var B=y[this.ref];B.theme=this.theme;B.disabled=false}})}function u(B){a.each(B,function(){this.disabled=!this.own;y[this.id]=this});A()}function x(D,C){if(D.theme==C){return}var E,B;if(!D.own){B="R";a.each(y,function(){if(this.type=="R"&&this.ref==D.id){E=this;return true}})}else{E=D;B=E.type}z({id:(E&&E.id)||"",name:D.name,type:B,theme:C,ref:D.id})}function o(){for(var B in s){s[B].empty()}a.each(y,function(){var I=this;if(I.type=="R"){return true}var C=I.own?(I.type=="S"?s.myShared:s.my):s.shared;if(!r&&I.own){r=I}var F,D,H,G,E;C.append(F=a('<li id="calendar_'+this.id+'" class="calendar-line event-theme-'+this.theme+(this.disabled?" calendar-disabled":"")+(r===I?" calendar-editable":"")+'"></li>').append(H=a('<input type="checkbox" checked="'+(I.enabled?"checked":"")+'" name="toggle-calendar-'+I.id+'"/>')).append(D=a('<span class="calendar-item">'+this.name+"</span>")).append(G=a('<span class="toggler">&nbsp;</span>')).append(E=I.own?a('<span class="remover">&nbsp;</span>'):"&nbsp;"));if(I.own){D.editable(function(K,J){I.name=K;z(I);return K});E.click(function(){w(I)})}G.click(function(){var J=a(this);l.managers.theme.attach(J,I,function(K){x(I,K)})});H.change(function(){I.disabled=!this.checked;F.toggleClass("calendar-disabled",I.disabled);l.managers.events.rerenderEvents(I.id)})});h()}this.read=v;this.getCalendar=function(){if(arguments.length==0){return r}return y[arguments[0]]};t();l.addListener(v);l.reportReady(this)}function d(){var q=[];var o=[];this.push=function(){function t(){}if(arguments.length>0){var s=arguments.length-1;var r=arguments[s];if(typeof r!="function"){r=t}else{s=s-1}if(arguments.length>1){o.push({methodName:arguments[0],params:a.grep(arguments,function(v,u){return u!=0&&u<=s})})}q.push(r)}};this.call=function(){l.managers.transport.proxy.system.multicall(function(t){var s=t.result,r=t.result.length;a.each(q,function(u,w){var v;if(u<r){v=s[u][0][3]}w(v)})},o)}}function g(){this.name="tickets";var o={};function q(){l.managers.transport.proxy.ticket.query(function(t){var s=new d();a.each(t.result,function(u,v){s.push("ticket.get",v,function(w){o[v]=w})});s.push(r);s.call()})}function r(){var s=a(c.tickets);a.each(o,function(w,u){var v,t;s.append(v=a('<li id="ticket_'+w+'" class="ticket"/>').append(t=a('<span class="ticket-mover">&#x00AB;</span>')).append('<span class="ticket-title">#'+w+" "+u.summary+"</span>"));t.click(function(){function A(){}function z(){a.fn.colorbox.close();return false}popup_context={setup:A,cancel:z,done:function(B){l.managers.events.renderEvent(B);return z()}};var y=l.managers.calendars.getCalendar();var x=y&&y.id||"";a.fn.colorbox({href:c.rootUrl+"/popup/events/?calendar="+x+"&ticket="+w+"&date="+(Math.ceil(new Date().getTime()/30/60/1000)*30*60),open:true,title:"Create Event"})})});h()}l.addListener(q);l.reportReady(this)}function b(){this.name="events";var v;function u(x){return Math.round(x.getTime()/1000)}function w(x,z){if(typeof z=="undefined"){z={}}for(p in x){z[p]=x[p]}if(typeof(x.start)!="object"){z.start=a.fullCalendar.parseISO8601(x.start||"",false)}if(typeof(x.end)!="object"){z.end=a.fullCalendar.parseISO8601(x.end||"",false)}z.title=x.name;var y=l.managers.calendars.getCalendar(x.calendar);if(y){if(y.type!="R"){z.editable=true}z.className=["event-theme-"+y.theme,(x.timetrack?" timetrac-enabled":""),(x.ticket&&x.ticket>0?" ticket-reference":"")]}e("mapped-event",z,x);return z}function t(A,x,z){var y=[];l.managers.transport.proxy.event.query(function(B){e("events-resp",B);a.each(B.result,function(){y.push(w(this))});z(y)},u(A),u(x),l.tzoffset)}function s(x){l.managers.transport.proxy.event.save(function(y){o(y.result)},x.id,x.calendar,x.title,x.allDay,x.start,x.end,x.description,x.ticket,x.timetrack,x.auto,x.time,l.tzoffset)}function o(x){var y=v.fullCalendar("clientEvents",x.id);if(y){y=y[0]}y=w(x,y);v.fullCalendar("renderEvent",y);y.source=t}function r(){function y(){}function x(){a.fn.colorbox.close();return false}popup_context={setup:y,cancel:x,done:function(z){o(z);return x()}}}function q(){e("rendering fullCalendar",c.target);v=a(c.target).fullCalendar({editable:false,disableDragging:false,disableResizing:false,firstHour:8,header:{left:"prev,next today",center:"title",right:"month,agendaWeek,agendaDay"},eventRender:function(A,y,x){var z=l.managers.calendars.getCalendar(A.calendar);return(z&&!z.disabled)},loading:function(x){if(x){a("#loading").show()}else{a("#loading").hide()}},dayClick:function(x,C,z,y){r();var B=l.managers.calendars.getCalendar();var A=B&&B.id||"";a.fn.colorbox({href:c.rootUrl+"/popup/events/?allDay="+C+"&calendar="+A+"&date="+u(x),open:true,title:"Create Event"})},eventClick:function(z,y,x){r();a.fn.colorbox({href:c.rootUrl+"/popup/events/"+z.id,open:true,title:"Edit Event"})},eventDrop:function(E,A,z,D,B,y,C,x){e("eventDrop",E,A,z,D);s(E)},eventResize:function(D,A,z,B,y,C,x){s(D)},viewDisplay:function(x){h()}})}this.renderEvent=o;this.rerenderEvents=function(x){e("rerenderEvents",x);if(x){a.each(v.fullCalendar("clientEvents",function(y){return y.calendar==x}),function(y,z){v.fullCalendar("updateEvent",w(z,z))})}v.fullCalendar("rerenderEvents")};this.init=function(){q();v.fullCalendar("addEventSource",t)};l.reportReady(this)}function j(){a(".fc-view td").droppable({accept:"#demo",tolerance:"pointer",hoverClass:"droppable-hover",over:function(){e("over",this);this.old_bg=a(this).css("backgound");a(this).css("background","#90e224 url(./../images/droppable-hover.png) 0 0")},out:function(){e("out",this);a(this).css("background",this.old_bg)},drop:function(){e("drop")}});a(".help").click(function(){var o=fullCalendar.fullCalendar("getView");e("view",o);o.reportEventElement({_id:"ticket_1"},a("#ticket_1"));o.draggableEvent({_id:"ticket_1"},a("#ticket_1"))})}new k();new i();new f();new g();new b()};a.fn.eventCalendar.defaults={my:"#my-calendars",myShared:"#my-shared-calendars",shared:"#shared-calendars",tickets:"#tickets",debug:false}})(jQuery);