(function(a){a.fn.ticketReferences=function(c){var b={managersQuantity:2,managers:{},reportReady:function(i){d("manager "+i.name+" reported that it is ready");this.managers[i.name]=i;var h=0;for(m in this.managers){h=h+1}if(h==this.managersQuantity){d("all managers ready. notifying.",this.listeners);if(typeof this["listeners"]!="undefined"){for(idx in this.listeners){d("notify listener "+idx);this.listeners[idx]()}}}},addListener:function(h){if(typeof this["listeners"]=="undefined"){this["listeners"]=[]}this.listeners.push(h)},tzoffset:new Date().getTimezoneOffset(),debug:false};var e=a.extend({},a.fn.ticketReferences.defaults,{target:a(this)},c);function d(){if(e.debug&&typeof console!="undefined"){console.log.apply("",arguments)}}function f(){this.name="transport";var i=this;d("init TransportManager with ",e.rpcurl);a.rpc(e.rpcurl,"xml",function(j){if(!j||!j.system){d("Could not get the rpc object ...");return}i.proxy=j;b.reportReady(i)});this.isReady=function(){return(typeof proxy=="undefined")};function h(j){return function(k){d("responseHandler",k,k.faultString);if(k&&k.error){alert(k.error.faultString)}else{j(k.result)}}}}function g(){this.name="references";d("init ticket manager");var i={},n=0,s;var h={};function q(){var t=a("form",a(e.searchSelector));d("searcher form",t);t.submit(function(){a(e.searchProgressSelector).show();a(e.searchResultsSelector).hide();var u=[];a("input:checkbox:checked",t).each(function(){u.push(this.name)});b.managers.transport.proxy.ticketconfig.references_search(function(v){a(e.searchProgressSelector).hide();a(e.searchResultsSelector).show();d("references search results",v);if(v.result){n=-1;i={};a.each(v.result,function(x,w){n=x;i[w.id]=w});n=n+1;l()}},a('input[name="q"]',t).val(),u);return false})}function j(){var t=typeof(e.dropTo)=="undefined"?e.target:a(e.dropTo,e.target);t.droppable({activeClass:"droppable-active",hoverClass:"droppable-hover",drop:function(u,v){d("the dropped candidate id",s);k(s,a(e.appendTarget));setTimeout(function(){a(v.draggable).draggable("destroy")},200)}});a("li",e.target).each(function(){var u=a(this);h[a(":hidden",u).val()]=u;p(u)})}function p(t){a(".t-trace-delete",t).click(function(){delete h[a(":hidden",t).val()];t.remove();return false})}function r(){j();q()}function k(t,u){var t=a('<li><input type="hidden" name="'+t.type+'_links" value="'+t.id+'"/><a href="'+e.baseurl+"/"+t.type+"/"+t.id+'" class="s-context s-icon-context s-icon s-icon-context-ticket">#'+t.id+"</a>"+t.title+'<a href="#" class="t-trace-delete" title="Delete reference">delete</a></li>');u.append(t);p(t);d("renderTraceItem",t,u)}function l(){var t=a(e.searchSummarySelector);var u=a(e.searchResultsSelector);u.empty();t.html("Search for References &mdash;"+n+" items found");a.each(i,function(w,v){u.append(o(v))})}function o(t){var u=a('<div class="w-ticket w-ticket-'+t.subtype+" reference-"+t.type+' s-widget-nofx"><div class="w-ticket-header"><h6><span class="w-ticket-number"><a href="'+e.baseurl+"/"+t.type+"/"+t.id+'">#'+t.id+"</a></span>&nbsp;"+t.title+'</h6></div><div class="w-ticket-body"><div class="w-ticket-description">'+t.excerpt+'</div><div class="s-columns w-ticket-toolbar"><div class="s-column-left">'+(t.author?'<div class="s-avatar-wrapper s-avatar-wrapper-20"><img class="s-avatar" width="20" height="20" alt="'+t.author+'" title="'+t.author+'" src="'+e.avatarResolver(e,t.author)+'" /></div>':"")+(t.date?'<div class="w-ticket-values">'+t.date+"</div>":"")+'</div><div class="s-column-right"><ul class="s-icon-bar">'+(t.type=="ticket"?'<li><a href="#" class="s-icon-button s-icon s-icon-edit-quick" title="Quick view/edit">View</a></li><li><a href="#" class="s-icon-button s-icon s-icon-edit" title="Full view/edit">Edit</a></li><li><a href="#" class="s-icon-button s-icon s-icon-comments" title="Comments">Comments</a></li>':"")+"</ul></div></div></div></div>");if(a('input[value="'+t.id+'"]',e.target).length==0){u.draggable({helper:"clone",start:function(v,w){w.helper.width(u.width());s=t}})}e.rendererCallback(u);return u}r();b.reportReady(this)}new f();new g()};a.fn.ticketReferences.defaults={baseurl:"",rpcurl:"/login/xmlrpc",searchProgressSelector:"#search-reference-progress",searchSelector:"#trac-ticket-edit-search-references",searchSummarySelector:"#trac-ticket-edit-search-references-results .references-search-summary > h4",searchResultsSelector:"#trac-ticket-edit-search-references-results .references-search-results",appendTarget:"#trac-outgoing-links",avatarResolver:function(c,b){return c.baseurl+"/chrome/itteco/images/avatar.png"},rendererCallback:function(b){},debug:false}})(jQuery);