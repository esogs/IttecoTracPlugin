(function(a){a.fn.extend({editableReport:function(m){var i;var c={};var e={fields:{ticket:{editable:false},description:{multiline:true}},delay:5000,rpcurl:"/login/xmlrpc",debug:true};var m=a.extend(e,m);function g(){if(m.debug&&typeof console!="undefined"){console.log.apply("",arguments)}}function f(){var n={type:"text",editable:true,options:{}};this.isEditable=function(o){var p=m.fields[o];if(typeof(p)=="undefined"){return false}return p.editable||n.editable};this.getFieldType=function(o){var p=m.fields[o]||n;return p.type||n.type};this.getFieldOptions=function(p){var q=[""];var r=m.fields[p]||n;var s=r.options||n.options;return q.concat(s)};this.setFieldValue=function(t,v,q){q=q||"";var s=m.fields[v];if(typeof(s)!="undefined"){var u=s.options;if(typeof(u)!="undefined"&&typeof(t[s.field_name])!="undefined"){try{var p=parseInt(q,10);if(!isNaN(p)){q=u[p-1];g("selection value for index="+p+" is "+q)}}catch(r){g("failed to convert to number")}}t[s.field_name]=q;return q}};this.getFieldValue=function(p,q){var o=m.fields[q];if(typeof(o)!="undefined"){return p[o.field_name]}}}function d(){var n={};var o={};this.dequeue=function(q){var p=n[q];if(typeof p!="undefined"){g("dequeue-ticket",q);delete n[q];clearTimeout(p);return true}return false};this.enqueue=function(p){g("enqueue-ticket",p);var q=this;delete o[p];this.dequeue(p);n[p]=setTimeout(function(){q.dequeue(p);k(p)},m.delay)};this.postpone=function(p){if(this.dequeue(p)){g("postpone-ticket",p);o[p]=true}};this.requeue=function(p){if(o[p]){g("requeue-ticket",p);delete o[p];this.enqueue(p)}}}function l(n){i=a.rpc(n,"xml",function(o){if(!o||!o.system){alert("Could not get the rpc object ..");return}g("rpc initialized")})}function b(n){if(typeof n!="string"){return n}return n.replace(/^\s+|\s+$/,"")}function k(o){var n=c[o];g("posting ticket content",n);i.ticket.update(function(p){if(typeof(p.result)!="undefined"){g("ticket "+o+" saved")}else{g("saving failed. error string =",p.error.faultString)}},o,"",n)}l(m.rpcurl);var j=new f();var h=new d();return this.each(function(){var n;a("table.tickets tbody tr",this).each(function(){$row=a(this);var r=a("td.ticket a",$row);if(r.length==1){var p=r.text().match(/#\d+/);var o=parseInt(p[0].substr(1),10);g("found-ticket-number",o);var q={};a("td",$row).each(function(){var w=a(this),x=a("a",w);var u=w.html(),s=x.outerHTML();var y=w.attr("class").split(" ");var t=y[0];var z=b(b(w.text()).replace("\n",""));if(j.isEditable(t)){j.setFieldValue(q,t,z);var v=j.getFieldType(t);w.editable(function(B,A){n=w;g("setting-ticket-field ",t," to ",B," for ticket",q);B=j.setFieldValue(q,t,B);h.enqueue(o);if(x.length>0){g("returning html as we have anchor");return u.replace(s,x.text(B).outerHTML())}return B},{data:function(){if(v=="select"){return j.getFieldOptions(t)}return j.getFieldValue(q,t)},placeholder:"&lt;n/a&gt;",type:v,submit:'<a class="field-editor-save">&nbsp;</a>',cancel:'<a class="field-editor-cancel">&nbsp;</a>',onedit:function(){if(n==w){return false}h.postpone(o)},onreset:function(){h.requeue(o)}})}});g("ticket-object",q);c[o]=q}});g("all-found-tickets",c)})},outerHTML:function(){return a("<div>").append(this.eq(0).clone()).html()}})})(jQuery);